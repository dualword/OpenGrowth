Preliminary comments: all the files provided will need to be adapted to your needs. They can not be used as a black-box.

You can find in this folder the files needed to perform molecular dynamic (MD) simulations with Gromacs and then perform the analysis with Amber.
The v5.0.2 of Gromacs was used on GPUs with the Amber12 package. The MD workflow is presented in MD-Workflow.png.

In the 00-Files/Structures folder you can find three files describing the structure of the system: 1HPV_Protein.pdb, 1HPV_Ligand.pdb and 1HPV_Water.pdb. They were prepared by using the Protein Preparation Wizard from Maestro (Schrodinger Inc.) with the PDB ID 1HPV. This step adds missing hydrogens, atoms, residues and minimizes the system. Water molecules further than 5 angstroms from the ligands were removed. If you don't want to keep the water in your system, you don't need to change anything. The script will complain at some point that it didn't find a file and will keep working. The charge of the ligand must be given in the file Charges.txt.

The first thing to do is to optimize the ligand. You can use "Run_Submit_01-Opt.sh" for that. It will prepare the files to optimize the ligand at the M062X/6-31+G** level of theory in a PCM of Water. Since we have a .pdb file as an input, the script converts it to a .xyz file first (with OpenBabel).

The second stage is to create the topology for the ligand. To do that, I use acpype.py which is an interface to antechamber and GAFF (General Amber Force Field). You can use "Run_Submit_02-Topology.sh". At the end, in a folder with the same name as the ligand, there will be three folders (01-Gaussian, 02-Antechamber, 03-${Name}.acpype) and three files (${Name}_GMX.itp, ${Name}_AC.frcmod, ${Name}.mol2). You need to copy these files in 00-Files/Structures.

The MD simulations can then be started with "Run_Submit_03-MD.sh". Our job manager (SLURM) supports job arrays so this script uses it; it runs 50 independant simulations (different only by the initial velocities). MD can fail, so in the script there is a loop that is done as long as the simulation didn't succeed. The simulations are done on GPUs ("-nb gpu" keyword in each line with mdrun). If you don't have GPUs, Gromacs should see it and tells you that it will run on CPUs; so you can keep the "-nb gpu" whether you have GPUs or not. The details of the simulations are in the .mdp files in the 00-Files. To check that the MD succeeded, you can use "Run_CheckJobs_03-MD.sh" which will create a new submission script with the MD that must be restarted. When you do 'grep "array" *New.sh', if it returns "#SBATCH --array=" it means that nothing should be restarted.

When the 50 simulations are successfully done, the MMPBSA analysis can be performed. Jobs can be started with "Run_Submit_04-MMPBSA.sh" and checked with "Run_CheckJobs_04-MMPBSA.sh". The full workflow is probably not optimal, but it is working smoothly. Snapshots are extracted from the MD trajectories. Each file is then slightly changed to be read with no errors by Amber for the MMPBSA. If you have histidine residues or disulfide bonds in your protein of interest, you must change slightly the 00-Files/Run_04-MMPBSA.sh file (details are given therein). If the script doesn't work, you will probably need to open one of the extracted pdb file and look at its structure. It is possible that the column giving the chain of the protein is missing for example. A "Gromacs2Amber.sed" file is then applied to the protein, ligand and complex files which are subsequently prepared and given as an input to tleap. All the prmtop will be the same and what we want to keep are the mdcrd files for the complex.

Finally, the entropy contributions can be estimated with "Run_Submit_05-Entropy.sh" and "Run_CheckJobs_05-Entropy.sh".

To perform the analysis, several scripts are provided. "Run_MMPBSA_GetAverage.sh" will return the average of the MMPBSA and MMPBSA-TDeltaS of the 50 simulations. It is important to check if all of the 5000 MMPBSA values follow a normal distribution. To check that, we provide "Run_MMPBSA_Analysis.sh" which will create a folder called 00-Analysis in which gnuplot will generate a figure (that should look like MD-MMPBSA.png). It can also be useful to open all the frames at 5ns and align them (with UCSF Chimera for example) to check that during the process of the trajectories there was no problem with the periodic boundary conditions; "Run_MMPBSA_Get-End-Structures.sh" gather all the structures in one folder. Finally, the script "Run_MMPBSA_ExtractData.sh" analyses all the MMPBSA and entropy calculations and returns the contribution of each part. The file "Run_Clean.sh" can be used to clean each folder.
